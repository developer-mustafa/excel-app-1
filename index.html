<!DOCTYPE html>
<html lang="bn" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
   
     <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.38.1/minified.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kalpurush&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#3B82F6',
                            600: '#2563EB',
                        },
                        secondary: {
                            500: '#10B981',
                            600: '#059669',
                        },
                        dark: {
                            800: '#1f2937',
                            900: '#111827'
                        },
                        category: {
  Math: '#2563EB',       // Bright Blue (blue-600)
  Logical: '#059669',    // Bright Emerald Green (emerald-600)
  Text: '#D97706',       // Bright Amber/Orange (amber-600)
  Lookup: '#DC2626',     // Bright Red (red-600)
  Date: '#7C3AED',       // Bright Purple (violet-600)
  Financial: '#0D9488',  // Bright Teal / Cyan (teal-600)
  Other: '#4B5563'       // Medium Slate Gray (gray-600)
}

                    }
                }
            }
        };

        // MathJax configuration
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <style>
        @font-face {
            font-family: 'Kalpurush';
            src: url('https://fonts.maateen.me/kalpurush/font.css') format('truetype');
        }
        .formula-card { transition: all 0.3s ease; border: 1px solid rgba(0, 0, 0, 0.05); }
        .formula-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .smooth-transition { transition: all 0.3s ease; }
        #recaptcha-container { display: inline-block; }
        .math-tex { font-size: 1.1em; line-height: 1.4; }
        .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #3B82F6 #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #3B82F6; border-radius: 10px; }
        .dark .scrollbar-thin::-webkit-scrollbar-track { background: #374151; }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb { background: #2563EB; }
        .formula-code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; }
        .copy-btn { transition: all 0.2s ease; }
        .copy-btn:active { transform: scale(0.95); }
        .truncate-formula { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .project-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 0.75rem; }
        .project-link { display: block; padding: 0.25rem 0.5rem; background-color: rgba(59, 130, 246, 0.1); border-radius: 0.25rem; font-size: 0.75rem; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; text-align: center; }
        .project-link:hover { background-color: rgba(59, 130, 246, 0.2); }
        @keyframes slow-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .animate-slow-blink { animation: slow-blink 3s infinite; }
    </style>
</head>

<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <header class="sticky top-0 z-40 flex flex-wrap justify-between items-center px-6 py-4 shadow-lg dark:shadow-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-white transition-colors duration-300">
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h1 class="text-xl md:text-2xl font-bold tracking-tight">Excel Pro</h1>
            </div>
            <a href="https://excel-app2.netlify.app/" target="_blank" class="hidden md:flex relative font-medium text-sm px-6 py-2 rounded-full text-white shadow-lg overflow-hidden transition-all duration-500 ease-in-out bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 transform hover:scale-105">
                Other excel app 2.0
            </a>
        </div>
        <div class="flex items-center space-x-3 sm:space-x-4">
            <button id="adminPanelBtn" class="hidden px-4 py-2 text-sm font-semibold rounded-lg bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-700 transition-colors duration-200">
                ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤
            </button>
            <button id="authButton" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">
                ‡¶≤‡¶ó‡¶á‡¶®
            </button>
            <button id="toggleMode" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
            <button onclick="exportPDF()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                </svg>
            </button>
            <button id="addFormulaBtn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
            </button>
        </div>
    </header>

    <div id="adminDashboardModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl p-6 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-3 dark:border-gray-700">
                <h3 class="text-xl font-bold">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h3>
                <button id="closeAdminModalBtn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto scrollbar-thin">
                <h4 class="text-lg font-semibold mb-3">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h4>
                <div id="userManagementLoader" class="text-center p-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-500 mx-auto"></div>
                    <p class="mt-2 text-sm text-gray-500">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
                </div>
                <table id="userManagementTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 hidden">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡¶®‡¶æ‡¶Æ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡¶≠‡ßÇ‡¶Æ‡¶ø‡¶ï‡¶æ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="userManagementTbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="addFormulaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="formulaForm" class="space-y-4">
                <div>
                    <label for="formulaTitle" class="block text-sm font-medium mb-1">‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="formulaTitle" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="formulaText" class="block text-sm font-medium mb-1">‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ</label>
                    <input type="text" id="formulaText" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600 font-mono">
                </div>
                <div>
                    <label for="formulaCategory" class="block text-sm font-medium mb-1">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</label>
                    <select id="formulaCategory" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                        <option value="Math">‡¶ó‡¶£‡¶ø‡¶§</option>
                        <option value="Logical">‡¶≤‡¶ú‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤</option>
                        <option value="Text">‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü</option>
                        <option value="Lookup">‡¶≤‡ßÅ‡¶ï‡¶Ü‡¶™</option>
                        <option value="Date">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</option>
                        <option value="Financial">‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶®‡ßç‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</option>
                        <option value="Other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
                    </select>
                </div>
                <div>
                    <label for="formulaDesc" class="block text-sm font-medium mb-1">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø)</label>
                    <textarea id="formulaDesc" rows="2" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></textarea>
                </div>
                <div>
                    <label for="formulaDescBn" class="block text-sm font-medium mb-1">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</label>
                    <textarea id="formulaDescBn" rows="2" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶∏‡¶Æ‡ßÇ‡¶π (‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß¨ ‡¶ü‡¶ø ‡¶è‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá)</label>
                        <button type="button" id="addProjectLink" class="text-xs px-2 py-1 bg-primary-500 text-white rounded hover:bg-primary-600">+ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                    <div id="projectLinksContainer" class="space-y-2"></div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelFormulaBtn" class="px-4 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700 smooth-transition">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 smooth-transition">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-red-600">‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <button onclick="document.getElementById('deleteModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-700 dark:text-gray-300">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø "<span id="deleteFormulaTitle" class="font-semibold"></span>" ‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶´‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶®‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('deleteModal').classList.add('hidden')" class="px-4 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700 smooth-transition">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 smooth-transition">‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <div id="formulaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                <h3 class="text-lg font-bold" id="formulaModalTitle">‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ</h3>
                <button onclick="document.getElementById('formulaModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="modal-content p-6 overflow-y-auto scrollbar-thin"></div>
            <div class="p-4 border-t dark:border-gray-700 flex justify-end">
                <button id="copyFormulaBtn" class="px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 copy-btn">‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold" id="authModalTitle">‡¶≤‡¶ó‡¶á‡¶®</h3>
                <button id="closeAuthModalBtn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="authFormContainer">
                <form id="loginForm" class="space-y-4">
                    <div><label for="loginEmail" class="block text-sm font-medium mb-1">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label><input type="email" id="loginEmail" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label for="loginPassword" class="block text-sm font-medium mb-1">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label><input type="password" id="loginPassword" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></div>
                    <div class="flex justify-between items-center"><button type="button" id="showRegisterBtn" class="text-sm text-primary-500 hover:underline">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button><button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 smooth-transition">‡¶≤‡¶ó‡¶á‡¶®</button></div>
                </form>
                <form id="registerForm" class="space-y-4 hidden">
                    <div><label for="registerName" class="block text-sm font-medium mb-1">‡¶®‡¶æ‡¶Æ</label><input type="text" id="registerName" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label for="registerEmail" class="block text-sm font-medium mb-1">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label><input type="email" id="registerEmail" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label for="registerPassword" class="block text-sm font-medium mb-1">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label><input type="password" id="registerPassword" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label for="registerConfirmPassword" class="block text-sm font-medium mb-1">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</label><input type="password" id="registerConfirmPassword" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></div>
                    <div class="flex justify-between items-center"><button type="button" id="showLoginBtn" class="text-sm text-primary-500 hover:underline">‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá?</button><button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 smooth-transition">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞</button></div>
                </form>
                <div id="phoneAuthForm" class="space-y-4 hidden">
                    <div><label for="phoneNumber" class="block text-sm font-medium mb-1">‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label><input type="tel" id="phoneNumber" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" placeholder="+8801XXXXXXXXX"></div>
                    <button id="sendOTPBtn" class="w-full px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 smooth-transition">OTP ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
                    <div class="text-center"><button type="button" id="showEmailLoginBtn" class="text-sm text-primary-500 hover:underline">‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
                    <div id="recaptcha-container"></div>
                </div>
                <div id="otpVerificationForm" class="space-y-4 hidden">
                    <div><label for="otpCode" class="block text-sm font-medium mb-1">OTP ‡¶ï‡ßã‡¶°</label><input type="text" id="otpCode" required class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" placeholder="6-digit code"></div>
                    <div class="flex justify-between items-center"><button type="button" id="resendOTPBtn" class="text-sm text-primary-500 hover:underline disabled:opacity-50">OTP ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button><button id="verifyOTPBtn" class="px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 smooth-transition">‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
                </div>
                <div class="mt-6">
                    <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-gray-600"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">‡¶Ö‡¶•‡¶¨‡¶æ</span></div></div>
                    <div class="mt-6 grid grid-cols-2 gap-3">
                        <button id="googleSignInBtn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 smooth-transition"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545 10.239v3.821h5.445c-0.712 2.315-2.647 3.972-5.445 3.972-3.332 0-6.033-2.701-6.033-6.032s2.701-6.032 6.033-6.032c1.498 0 2.866 0.549 3.921 1.453l2.814-2.814c-1.784-1.664-4.153-2.675-6.735-2.675-5.522 0-10 4.479-10 10s4.478 10 10 10c8.396 0 10-7.524 10-10 0-0.668-0.068-1.324-0.182-1.961h-9.818z" /></svg><span class="ml-2">Google</span></button>
                        <button id="phoneSignInBtn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 smooth-transition"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2 3.5A1.5 1.5 0 0 1 3.5 2h3A1.5 1.5 0 0 1 8 3.5v3A1.5 1.5 0 0 1 6.5 8h-1a.5.5 0 0 0-.5.6c.2 1.2.7 2.4 1.4 3.5a14 14 0 0 0 6 6c1 .6 2.2 1.1 3.5 1.4a.5.5 0 0 0 .6-.5v-1A1.5 1.5 0 0 1 17.5 13h3A1.5 1.5 0 0 1 22 14.5v3a1.5 1.5 0 0 1-1.5 1.5c-9.4 0-17-7.6-17-17A1.5 1.5 0 0 1 2 3.5z" /></svg><span class="ml-2">‡¶´‡ßã‡¶®</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl" style="max-height: 90vh; min-width: 320px;">
            <button onclick="document.getElementById('dashboardModal').classList.add('hidden')" class="absolute top-4 right-4 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div class="flex flex-col md:flex-row h-full">
                <div class="bg-gradient-to-br from-primary-500 to-primary-600 dark:from-gray-700 dark:to-gray-800 p-6 text-white md:w-64 flex-shrink-0">
                    <div class="flex flex-col items-center h-full">
                        <div class="relative mb-4"><img id="userPhoto" src="https://ui-avatars.com/api/?name=U&background=3B82F6&color=ffffff" alt="User" class="w-20 h-20 rounded-full border-4 border-white/30 shadow-md mx-auto"></div>
                        <h3 id="userName" class="text-lg font-bold mb-1 text-center">User Name</h3>
                        <p id="userEmail" class="text-sm opacity-90 mb-3 text-center">user@example.com</p>
                        <p id="accountCreated" class="text-xs opacity-75 mb-6 text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>Joined <span id="joinDate">MMM YYYY</span></p>
                        <button id="logoutBtn" class="mt-auto w-full py-2 px-4 bg-white/20 hover:bg-white/30 rounded-lg border border-white/30 flex items-center justify-center transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h14m-6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> Logout</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-6 scrollbar-thin" style="max-height: calc(90vh - 2rem);">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Account Settings</h2>
                    <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4 mb-4">
                        <h3 class="font-medium flex items-center mb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> Profile Information</h3>
                        <form id="profileForm" class="space-y-3">
                            <div><label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Full Name</label><input type="text" id="profileName" class="w-full px-3 py-2 rounded border dark:bg-gray-600 dark:border-gray-500"></div>
                            <div><label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Profile Photo</label><div class="items-center space-x-3"><img id="profilePhotoPreview" src="https://ui-avatars.com/api/?name=U" class="w-10 h-10 rounded-full"><label class="flex-1"><div class="px-3 py-1.5 bg-gray-50 dark:bg-gray-600 hover:bg-gray-100 dark:hover:bg-gray-500 border border-gray-300 dark:border-gray-500 rounded cursor-pointer text-center text-sm">Change Photo<input type="file" id="profilePhoto" accept="image/*" class="hidden"></div></label></div></div>
                            <button type="submit" class="w-full md:w-auto px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded transition-colors">Save Profile</button>
                        </form>
                    </div>
                    <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4">
                        <h3 class="font-medium flex items-center mb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg> Change Password</h3>
                        <form id="passwordForm" class="space-y-3">
                            <div><label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Current Password</label><input type="password" id="currentPassword" class="w-full px-3 py-2 rounded border dark:bg-gray-600 dark:border-gray-500"></div>
                            <div><label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">New Password</label><input type="password" id="newPassword" class="w-full px-3 py-2 rounded border dark:bg-gray-600 dark:border-gray-500"></div>
                            <div><label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Confirm New Password</label><input type="password" id="confirmPassword" class="w-full px-3 py-2 rounded border dark:bg-gray-600 dark:border-gray-500"></div>
                            <button type="submit" class="w-full md:w-auto px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded transition-colors">Change Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="container mx-auto px-4 py-6">
        <div class="mb-6 p-4 rounded-lg bg-gray-50 dark:bg-gray-800 shadow">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label for="searchInput" class="block text-sm font-medium mb-1">‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <input type="text" id="searchInput" placeholder="‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ, ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£, ‡¶¨‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..." class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="md:w-48">
                    <label for="categoryFilter" class="block text-sm font-medium mb-1">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</label>
                    <select id="categoryFilter" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                        <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option>
                        <option value="Math">‡¶ó‡¶£‡¶ø‡¶§</option>
                        <option value="Logical">‡¶≤‡¶ú‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤</option>
                        <option value="Text">‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü</option>
                        <option value="Lookup">‡¶≤‡ßÅ‡¶ï‡¶Ü‡¶™</option>
                        <option value="Date">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</option>
                        <option value="Financial">‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶®‡ßç‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</option>
                        <option value="Other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="formulaGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div id="loadingIndicator" class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"></div>
        </div>
        <div id="noResults" class="hidden text-center py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <h3 class="mt-4 text-lg font-medium text-gray-700 dark:text-gray-300">‡¶ï‡ßã‡¶® ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</h3>
            <p class="mt-2 text-gray-500 dark:text-gray-400">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡¶ø‡¶≤‡ßá ‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶è‡¶Æ‡¶® ‡¶ï‡ßã‡¶® ‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</p>
        </div>
    </main>

</body>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyARd-ddfvT2LVlqTvTSon7L_pidB7tB8Bw",
        authDomain: "excel-app-7748a.firebaseapp.com",
        projectId: "excel-app-7748a",
        storageBucket: "excel-app-7748a.appspot.com",
        messagingSenderId: "373982496248",
        appId: "1:373982496248:web:21e0ef021d0fa2de30c20d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let isCurrentUserAdmin = false;
    let formulas = [];
    let filteredFormulas = [];
    let currentEditingId = null;
    let projectLinkCount = 0;
    let deleteFormulaId = null;
    let currentFormulaInModal = null;

    const formulaGrid = document.getElementById('formulaGrid');
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noResults = document.getElementById('noResults');
    const addFormulaBtn = document.getElementById('addFormulaBtn');
    const addFormulaModal = document.getElementById('addFormulaModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelFormulaBtn = document.getElementById('cancelFormulaBtn');
    const formulaForm = document.getElementById('formulaForm');
    const authButton = document.getElementById('authButton');
    const authModal = document.getElementById('authModal');
    const closeAuthModalBtn = document.getElementById('closeAuthModalBtn');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const phoneSignInBtn = document.getElementById('phoneSignInBtn');
    const showEmailLoginBtn = document.getElementById('showEmailLoginBtn');
    const phoneAuthForm = document.getElementById('phoneAuthForm');
    const sendOTPBtn = document.getElementById('sendOTPBtn');
    const otpVerificationForm = document.getElementById('otpVerificationForm');
    const verifyOTPBtn = document.getElementById('verifyOTPBtn');
    const resendOTPBtn = document.getElementById('resendOTPBtn');
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const addProjectLinkBtn = document.getElementById('addProjectLink');
    const projectLinksContainer = document.getElementById('projectLinksContainer');
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const formulaModal = document.getElementById('formulaModal');
    const copyFormulaBtn = document.getElementById('copyFormulaBtn');
    const adminPanelBtn = document.getElementById('adminPanelBtn');
    const adminDashboardModal = document.getElementById('adminDashboardModal');
    const closeAdminModalBtn = document.getElementById('closeAdminModalBtn');

    function initApp() {
        loadFormulas();
        setupEventListeners();
        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().role === 'admin') {
                    isCurrentUserAdmin = true;
                    adminPanelBtn.classList.remove('hidden');
                } else {
                    isCurrentUserAdmin = false;
                    adminPanelBtn.classList.add('hidden');
                }
                authButton.textContent = user.displayName || '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤';
                addFormulaBtn.classList.remove('hidden');
            } else {
                currentUser = null;
                isCurrentUserAdmin = false;
                authButton.textContent = '‡¶≤‡¶ó‡¶á‡¶®';
                addFormulaBtn.classList.add('hidden');
                adminPanelBtn.classList.add('hidden');
            }
            renderFormulas();
        });
    }

    function loadFormulas() {
        loadingIndicator.classList.remove('hidden');
        db.collection('formulas').orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
                formulas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFormulas();
                loadingIndicator.classList.add('hidden');
            }, error => {
                console.error('Error loading formulas:', error);
                loadingIndicator.classList.add('hidden');
                formulaGrid.innerHTML = `<div class="col-span-full text-center py-12"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="mt-4 text-lg font-medium text-gray-700 dark:text-gray-300">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</h3><p class="mt-2 text-gray-500 dark:text-gray-400">‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶™‡¶∞‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p></div>`;
            });
    }

    function renderFormulas() {
        applyFilters();
        if (filteredFormulas.length === 0) {
            noResults.classList.remove('hidden');
            formulaGrid.innerHTML = '';
            return;
        }
        noResults.classList.add('hidden');
        formulaGrid.innerHTML = filteredFormulas.map(formula => {
            const categoryColor = `category-${formula.category}`;
            const categoryBgColor = `bg-${categoryColor}/10`;
            const categoryTextColor = `text-${categoryColor}`;
            const categoryBorderColor = `border-${categoryColor}/20`;
            const maxLength = 150;
            const shouldTruncate = formula.formula.length > maxLength;
            const truncatedFormula = shouldTruncate ? formula.formula.substring(0, maxLength) + '...' : formula.formula;
            const projectLinks = formula.projectLinks || [];

            // Show edit/delete buttons if user is admin OR is the author of the formula
            const canManageFormula = currentUser && (isCurrentUserAdmin || formula.userId === currentUser.uid);

            return `
          <div class="formula-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden h-full flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 ${categoryBgColor} ${categoryBorderColor}">
              <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-lg">${formula.title}</h3>
                <span class="text-xs px-2 py-1 rounded-full ${categoryBgColor} ${categoryTextColor} ${categoryBorderColor} border">${getCategoryName(formula.category)}</span>
              </div>
              <div class="formula-code bg-[rgb(49,148,169)] text-white dark:bg-gray-900 p-3 rounded text-sm mb-3" title="${formula.formula}">
                <div id="formula-content-${formula.id}" class="truncate-formula">${shouldTruncate ? truncatedFormula : formula.formula}</div>
                ${shouldTruncate ? `<button onclick="toggleFormula('${formula.id}')" class="toggle-btn text-sm dark:text-blue-400 dark:hover:text-red-500 m-2">‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßÇ‡¶§‡ßç‡¶∞‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì...</button>` : ''}
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-300 "> <b class="text-yellow-600">‡¶¨‡¶∞‡ßç‡¶£‡¶®‡¶æ (BN): </b> ${formula.description_bn}</p>
            </div>
            <div class="p-4 border-b dark:border-gray-700">
              <b class="text-sm mb-2 text-purple-500">‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶∏‡¶Æ‡ßÇ‡¶π:</b>
              ${projectLinks.length > 0 ? `<div class="project-links">${projectLinks.slice(0, 6).map((link, index) => `<a href="${link.url}" target="_blank" class="project-link" title="${link.title || '‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï'}">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü-${index + 1}</a>`).join('')}</div>` : `<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">‡¶è‡¶á ‡¶´‡¶∞‡ßç‡¶Æ‡ßÇ‡¶≤‡¶æ‡¶∞ ‡¶Ö‡¶ß‡¶ø‡¶®‡ßá ‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶è‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</p>`}
            </div>
            <div class="p-4 mt-auto">
              <div class="flex justify-between items-center">
                <div class="flex space-x-2">
                  <button onclick="viewFormula('${formula.id}')" class="text-primary-500 hover:text-primary-600 text-sm font-medium">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                  <button onclick="copyFormulaToClipboard('${formula.id}')" class="text-green-500 hover:text-green-700 text-sm font-bold copy-btn flex justify-center items-center" title="‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®">copy <svg xmlns="http://www.w3.org/2000/svg" class="h-8 max-w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg></button>
                </div>
                ${canManageFormula ? `
                  <div class="flex space-x-2">
                    <button onclick="editFormula('${formula.id}')" class="p-1 text-blue-500 hover:text-blue-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                    <button onclick="showDeleteModal('${formula.id}', '${formula.title.replace(/'/g, "\\'")}')" class="p-1 text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>`;
        }).join('');
        if (window.MathJax) { window.MathJax.typesetPromise(); }
    }
    
    async function copyFormulaToClipboard(formulaId) {
        const formula = formulas.find(f => f.id === formulaId);
        if (!formula) return;
        try {
            await navigator.clipboard.writeText(formula.formula);
            const copyButtons = document.querySelectorAll(`button[onclick="copyFormulaToClipboard('${formulaId}')"]`);
            copyButtons.forEach(btn => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
            });
        } catch (err) {
            console.error('Could not copy text: ', err);
            alert('‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
        }
    }

    function toggleFormula(formulaId) {
        const formulaContent = document.getElementById(`formula-content-${formulaId}`);
        const formula = formulas.find(f => f.id === formulaId);
        if (!formula) return;
        const buttons = document.querySelectorAll(`button[onclick="toggleFormula('${formulaId}')"]`);
        if (formulaContent.classList.contains('truncate-formula')) {
            formulaContent.textContent = formula.formula;
            formulaContent.classList.remove('truncate-formula');
            buttons.forEach(btn => { btn.textContent = '‡¶∏‡ßÇ‡¶§‡ßç‡¶∞ ‡¶ï‡¶Æ‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì'; });
        } else {
            const maxLength = 150;
            formulaContent.textContent = formula.formula.length > maxLength ? formula.formula.substring(0, maxLength) + '...' : formula.formula;
            formulaContent.classList.add('truncate-formula');
            buttons.forEach(btn => { btn.textContent = '‡¶™‡ßÅ‡¶∞‡ßã‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì'; });
        }
    }

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const category = categoryFilter.value;
        filteredFormulas = formulas.filter(formula => {
            const matchesSearch = searchTerm === '' || formula.title.toLowerCase().includes(searchTerm) || formula.formula.toLowerCase().includes(searchTerm) || (formula.description && formula.description.toLowerCase().includes(searchTerm)) || (formula.description_bn && formula.description_bn.toLowerCase().includes(searchTerm)) || formula.category.toLowerCase().includes(searchTerm);
            const matchesCategory = category === 'all' || formula.category === category;
            return matchesSearch && matchesCategory;
        });
    }

    function getCategoryName(category) {
        const categories = { 'Math': '‡¶ó‡¶£‡¶ø‡¶§', 'Logical': '‡¶≤‡¶ú‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤', 'Text': '‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü', 'Lookup': '‡¶≤‡ßÅ‡¶ï‡¶Ü‡¶™', 'Date': '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ', 'Financial': '‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶®‡ßç‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤', 'Other': '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø' };
        return categories[category] || category;
    }

    function viewFormula(id) {
        const formula = formulas.find(f => f.id === id);
        if (!formula) return;
        currentFormulaInModal = formula;
        document.getElementById('formulaModalTitle').textContent = formula.title;
        const projectLinks = formula.projectLinks || [];
        document.querySelector('.modal-content').innerHTML = `
        <div class="space-y-4">
          <div><h4 class="font-medium mb-1">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</h4><span class="inline-block px-2 py-1 rounded-full bg-category-${formula.category}/10 text-category-${formula.category} border border-category-${formula.category}/20 text-sm">${getCategoryName(formula.category)}</span></div>
          <div><h4 class="font-medium mb-1">‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ</h4><div class="bg-gray-100 dark:bg-gray-700 p-3 rounded formula-code">${formula.formula}</div></div>
          <div><h4 class="font-medium mb-1">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø)</h4><p class="text-gray-700 dark:text-gray-300">${formula.description || 'N/A'}</p></div>
          <div><h4 class="font-medium mb-1">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</h4><p class="text-gray-700 dark:text-gray-300">${formula.description_bn || 'N/A'}</p></div>
          ${projectLinks.length > 0 ? `<div><h4 class="font-medium mb-2">‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶∏‡¶Æ‡ßÇ‡¶π</h4><div class="space-y-2">${projectLinks.map((link, index) => `<div class="flex items-center p-2 bg-gray-50 dark:bg-gray-600 rounded"><span class="text-sm font-medium mr-2">${index + 1}.</span><a href="${link.url}" target="_blank" class="text-primary-500 hover:underline flex-1 truncate" title="${link.title || link.url}">${link.title || link.url}</a></div>`).join('')}</div></div>` : ''}
        </div>`;
        formulaModal.classList.remove('hidden');
    }

    function editFormula(id) {
        const formula = formulas.find(f => f.id === id);
        if (!formula) return;
        const canManageFormula = currentUser && (isCurrentUserAdmin || formula.userId === currentUser.uid);
        if (!canManageFormula) {
            alert('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ‡¶ü‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á‡•§');
            return;
        }
        currentEditingId = id;
        document.getElementById('formulaTitle').value = formula.title;
        document.getElementById('formulaText').value = formula.formula;
        document.getElementById('formulaCategory').value = formula.category;
        document.getElementById('formulaDesc').value = formula.description || '';
        document.getElementById('formulaDescBn').value = formula.description_bn || '';
        projectLinksContainer.innerHTML = '';
        projectLinkCount = 0;
        if (formula.projectLinks) {
            formula.projectLinks.forEach(link => addProjectLinkField(link.title, link.url));
        }
        addFormulaModal.classList.remove('hidden');
    }

    function showDeleteModal(id, title) {
        const formula = formulas.find(f => f.id === id);
        const canManageFormula = currentUser && (isCurrentUserAdmin || (formula && formula.userId === currentUser.uid));
        if (!canManageFormula) {
            alert('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á‡•§');
            return;
        }
        deleteFormulaId = id;
        document.getElementById('deleteFormulaTitle').textContent = title;
        deleteModal.classList.remove('hidden');
    }
    
    function addProjectLinkField(title = '', url = '') {
        if (projectLinkCount >= 6) { alert('‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß¨‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§'); return; }
        const linkHtml = `<div class="flex items-end space-x-2 project-link-item">
          <div class="flex-1"><label class="block text-xs font-medium mb-1">‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤</label><input type="text" placeholder="‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" value="${title}" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600 text-sm" name="projectLinkTitle[]"></div>
          <div class="flex-1"><label class="block text-xs font-medium mb-1">URL</label><input type="url" placeholder="https://example.com" value="${url}" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600 text-sm" name="projectLinkUrl[]"></div>
          <button type="button" onclick="removeProjectLink(this)" class="p-2 text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>`;
        projectLinksContainer.insertAdjacentHTML('beforeend', linkHtml);
        projectLinkCount++;
    }

    function removeProjectLink(button) {
        button.closest('.project-link-item').remove();
        projectLinkCount--;
    }

    function exportPDF() { /* PDF export functionality remains the same */ }

    // Admin Panel Functions
    async function loadUsersForAdminPanel() {
        const loader = document.getElementById('userManagementLoader');
        const table = document.getElementById('userManagementTable');
        const tbody = document.getElementById('userManagementTbody');
        
        loader.style.display = 'block';
        table.classList.add('hidden');
        tbody.innerHTML = '';

        try {
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                const isAdmin = user.role === 'admin';
                
                const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors";

        tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-semibold text-gray-900 dark:text-white">${user.name}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-600 dark:text-gray-300">${user.email}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-3 py-1 inline-flex text-xs leading-5 font-medium rounded-full shadow-sm ${isAdmin ? 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'}">
                    ${isAdmin ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : '‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                <button onclick="toggleAdminRole('${userId}', ${isAdmin})"
                    class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-100 text-indigo-700 hover:bg-indigo-200 dark:bg-indigo-800 dark:text-indigo-200 dark:hover:bg-indigo-700 transition">
                    ${isAdmin ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠' : '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ‡¶®‡¶æ‡¶®'}
                </button>
                <button onclick="deleteUser('${userId}', '${user.name.replace(/'/g, "\\'")}')"
                    class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-800 dark:text-red-200 dark:hover:bg-red-700 transition">
                    ‡¶°‡¶ø‡¶≤‡ßá‡¶ü
                </button>
            </td>
        `;
        tbody.appendChild(tr);
            });
        } catch (error) {
            console.error("Error loading users:", error);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§</td></tr>';
        } finally {
            loader.style.display = 'none';
            table.classList.remove('hidden');
        }
    }

    async function toggleAdminRole(userId, isAdmin) {
        if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) return;
        try {
            const newRole = isAdmin ? null : 'admin';
            await db.collection('users').doc(userId).update({ role: newRole });
            loadUsersForAdminPanel(); // Refresh the list
        } catch (error) {
            console.error("Error toggling admin role:", error);
            alert("‡¶≠‡ßÇ‡¶Æ‡¶ø‡¶ï‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
        }
    }

    async function deleteUser(userId, userName) {
        if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø "${userName}" ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶´‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶®‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§`)) return;
        try {
            // Note: This only deletes the Firestore user document, not the Firebase Auth user.
            // For a full user deletion, a Cloud Function is required.
            await db.collection('users').doc(userId).delete();
            loadUsersForAdminPanel(); // Refresh the list
        } catch (error) {
            console.error("Error deleting user:", error);
            alert("‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
        }
    }

    function setupEventListeners() {
        searchInput.addEventListener('input', renderFormulas);
        categoryFilter.addEventListener('change', renderFormulas);

        adminPanelBtn.addEventListener('click', () => {
            adminDashboardModal.classList.remove('hidden');
            loadUsersForAdminPanel();
        });
        closeAdminModalBtn.addEventListener('click', () => {
            adminDashboardModal.classList.add('hidden');
        });

        addFormulaBtn.addEventListener('click', () => {
            if (!currentUser) { alert('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞‡¶æ ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§'); return; }
            formulaForm.reset();
            currentEditingId = null;
            projectLinksContainer.innerHTML = '';
            projectLinkCount = 0;
            addFormulaModal.classList.remove('hidden');
        });
        closeModalBtn.addEventListener('click', () => addFormulaModal.classList.add('hidden'));
        cancelFormulaBtn.addEventListener('click', () => addFormulaModal.classList.add('hidden'));

        formulaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { alert('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞‡¶æ ‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§'); return; }
            const projectLinks = [];
            const linkTitleInputs = document.querySelectorAll('input[name="projectLinkTitle[]"]');
            const linkUrlInputs = document.querySelectorAll('input[name="projectLinkUrl[]"]');
            for (let i = 0; i < linkTitleInputs.length; i++) {
                if (linkUrlInputs[i].value.trim()) {
                    projectLinks.push({ title: linkTitleInputs[i].value.trim() || `Project ${i + 1}`, url: linkUrlInputs[i].value.trim() });
                }
            }
            const formulaData = {
                title: document.getElementById('formulaTitle').value,
                formula: document.getElementById('formulaText').value,
                category: document.getElementById('formulaCategory').value,
                description: document.getElementById('formulaDesc').value,
                description_bn: document.getElementById('formulaDescBn').value,
                projectLinks,
                createdBy: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            };
            try {
                if (currentEditingId) {
                    await db.collection('formulas').doc(currentEditingId).update(formulaData);
                } else {
                    formulaData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('formulas').add(formulaData);
                }
                addFormulaModal.classList.add('hidden');
            } catch (error) {
                console.error('Error saving formula:', error);
                alert('‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
            }
        });
        
        addProjectLinkBtn.addEventListener('click', () => addProjectLinkField());

        authButton.addEventListener('click', () => {
            if (currentUser) { showDashboard(); } 
            else { authModal.classList.remove('hidden'); }
        });
        closeAuthModalBtn.addEventListener('click', () => { authModal.classList.add('hidden'); resetAuthForms(); });

        showRegisterBtn.addEventListener('click', () => { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        showLoginBtn.addEventListener('click', () => { registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        phoneSignInBtn.addEventListener('click', () => { loginForm.classList.add('hidden'); registerForm.classList.add('hidden'); phoneAuthForm.classList.remove('hidden'); });
        showEmailLoginBtn.addEventListener('click', () => { phoneAuthForm.classList.add('hidden'); otpVerificationForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
                authModal.classList.add('hidden');
                resetAuthForms();
            } catch (error) { alert(`‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${error.message}`); }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('registerPassword').value;
            if (password !== document.getElementById('registerConfirmPassword').value) { alert('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡ßá‡¶≤‡ßá‡¶®‡¶ø‡•§'); return; }
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                await db.collection('users').doc(userCredential.user.uid).set({ name, email, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                authModal.classList.add('hidden');
                resetAuthForms();
            } catch (error) { alert(`‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${error.message}`); }
        });

        googleSignInBtn.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                // Create user doc in Firestore if it's a new user
                const userDocRef = db.collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();
                if (!userDoc.exists) {
                    await userDocRef.set({
                        name: user.displayName,
                        email: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                authModal.classList.add('hidden');
                resetAuthForms();
            } catch (error) { alert(`Google ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${error.message}`); }
        });

        // Other event listeners (phone auth, delete, copy, etc.) remain largely the same...
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!deleteFormulaId) return;
            try {
                await db.collection('formulas').doc(deleteFormulaId).delete();
                deleteModal.classList.add('hidden');
                deleteFormulaId = null;
            } catch (error) { alert('‡¶´‡¶∞‡ßç‡¶Æ‡ßÅ‡¶≤‡¶æ ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§'); }
        });

        copyFormulaBtn.addEventListener('click', async () => {
            if (!currentFormulaInModal) return;
            try {
                await navigator.clipboard.writeText(currentFormulaInModal.formula);
                copyFormulaBtn.textContent = '‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!';
                setTimeout(() => { copyFormulaBtn.textContent = '‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®'; }, 2000);
            } catch (err) { console.error('Could not copy text: ', err); }
        });

        document.getElementById('toggleMode').addEventListener('click', () => {
            const html = document.documentElement;
            html.classList.toggle('dark');
            localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
        });
    }

    function resetAuthForms() {
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
        phoneAuthForm.classList.add('hidden');
        otpVerificationForm.classList.add('hidden');
        loginForm.reset();
        registerForm.reset();
    }

    function showDashboard() {
        if (!currentUser) return;
        document.getElementById('userName').textContent = currentUser.displayName || 'User';
        document.getElementById('userEmail').textContent = currentUser.email;
        document.getElementById('userPhoto').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || 'U')}&background=3B82F6&color=ffffff`;
        if (currentUser.metadata.creationTime) {
            const joinDate = new Date(currentUser.metadata.creationTime);
            document.getElementById('joinDate').textContent = joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        }
        document.getElementById('dashboardModal').classList.remove('hidden');
        document.getElementById('logoutBtn').onclick = () => {
            auth.signOut();
            document.getElementById('dashboardModal').classList.add('hidden');
        };
    }

    document.addEventListener('DOMContentLoaded', initApp);
</script>

</html>